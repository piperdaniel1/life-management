# Life Management

Personal todo/task management app. Sign-up is disabled in the UI — users are created manually in the Supabase dashboard.

## Tech Stack

- **Frontend**: React 19 + TypeScript + Tailwind CSS 4, bundled with Vite 6
- **Backend**: Supabase (Postgres DB with RLS, Auth, Realtime, Edge Functions)
- **Hosting**: Netlify static site
- **Pattern**: Client talks directly to Supabase via anon key + RLS. Edge functions use `service_role` key for operations that bypass RLS.

## Project Structure

```
src/
  components/       UI components (Auth, TodoList, TodoItem)
  hooks/            useAuth (session state), useTodos (CRUD + realtime)
  lib/              Supabase client init
  types/
    database.ts     AUTO-GENERATED — do not edit, run `npm run db:types`
    models.ts       Type aliases (Todo, TodoInsert, TodoUpdate) — edit this
  App.tsx           Root: auth gate → header + TodoList
  main.tsx          React entry point
  index.css         Tailwind import

supabase/
  config.toml       Supabase CLI config (generated by `supabase init`)
  migrations/       Timestamped SQL files, applied with `npm run db:migrate`
  functions/        Deno edge functions (deployed separately)
```

## Commands

```
npm run dev              # Vite dev server (localhost:5173)
npm run build            # TypeScript check + production build → dist/
npm run db:link          # Link to remote Supabase project (one-time)
npm run db:migrate       # Push migrations to remote DB
npm run db:migration:new # Create new timestamped migration file
npm run db:reset         # Reset remote DB and replay all migrations
npm run db:types         # Regenerate src/types/database.ts from live schema
```

## Database Workflow

1. Create a new migration: `npm run db:migration:new <name>`
2. Write SQL in the generated file under `supabase/migrations/`
3. Push to remote: `npm run db:migrate`
4. Regenerate types: `npm run db:types`
5. Update `src/types/models.ts` if new tables/type aliases are needed

`src/types/database.ts` is auto-generated and will be overwritten by `db:types`. Put custom type aliases in `src/types/models.ts`.

## Key Patterns

- **RLS everywhere**: All tables have row-level security. Policies scope data to `auth.uid() = user_id`. The client uses the anon key.
- **Realtime sync**: `useTodos` subscribes to `postgres_changes` on the todos table. Enable Replication for new tables in the Supabase dashboard.
- **Edge functions for privileged ops**: Use `SUPABASE_SERVICE_ROLE_KEY` (set in Supabase secrets) when you need to bypass RLS (e.g., cleanup jobs, admin operations).
- **No sign-up UI**: Auth component is sign-in only. Create users manually in Supabase dashboard > Authentication > Users.
- **Code splitting**: Route-level components (Auth, Dashboard) and heavy modals are lazy-loaded with `React.lazy()` + `<Suspense>`. Vendor deps are split into cacheable chunks via `manualChunks` in `vite.config.ts`. When adding a new dependency, add a matching `id.includes("node_modules/<pkg>")` rule to `manualChunks` — use the function form, not the array form, so subpath imports (e.g. `react-dom/client`) are caught.

## Environment Variables

Frontend (set in `.env` locally and in Netlify for deploys):
```
VITE_SUPABASE_URL=https://<project>.supabase.co
VITE_SUPABASE_ANON_KEY=<anon-key>
```

These are public/safe — security comes from RLS, not key secrecy.

## Adding a New Table

1. `npm run db:migration:new create_<table>`
2. Write the migration SQL (create table, indexes, RLS policies)
3. `npm run db:migrate`
4. `npm run db:types`
5. Add type aliases to `src/types/models.ts`
6. Create a `use<Table>` hook following the `useTodos` pattern
7. If the table needs realtime, enable it in Supabase dashboard > Database > Replication

## Deployment

- Netlify auto-deploys from the connected git repo
- `netlify.toml` configures build command (`npm run build`), publish dir (`dist`), and SPA redirect
- Set `VITE_SUPABASE_URL` and `VITE_SUPABASE_ANON_KEY` in Netlify > Site configuration > Environment variables

## Edge Functions

Located in `supabase/functions/<name>/index.ts`. Deno runtime.

Deploy: `npx supabase functions deploy <name>`

Current functions:
- `cleanup-completed` — deletes completed todos older than 30 days. Not on a schedule yet; call manually or set up a cron.
